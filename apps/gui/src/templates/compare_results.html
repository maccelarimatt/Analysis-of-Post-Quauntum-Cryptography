<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PQC Bench – Compare Results</title>
  <style>
    :root { --island-bg: rgba(128,128,128,.9); --island-radius:1.5rem; --text:#fff; --accent:#1fb6b8; }
    /* Reduce top padding so header sits closer to top */
    body { margin:0; padding:0.1vh 5vw 5vh; color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; background-image:url('/static/Images/background.gif'); background-size:cover; background-position:center; background-repeat:no-repeat; background-attachment:fixed; }
    .island { background:var(--island-bg); border-radius:var(--island-radius); padding:2rem; backdrop-filter: blur(4px); max-width:1200px; margin:0 auto 2vh auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; }
    .card { background: rgba(0,0,0,.25); border-radius:.75rem; padding:1rem; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:.45rem .35rem; border-bottom: 1px dashed rgba(255,255,255,.2); }
    /* Vertical lines between columns for comparison tables */
    table.vlines th:not(:last-child),
    table.vlines td:not(:last-child) { border-right: 1px solid rgba(255,255,255,.25); }
    table.vlines thead th { border-bottom: 1px solid rgba(255,255,255,.35); }

    /* Refined details layout */
    /* Layout: fewer cards per row for better readability */
    .details-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) {
      .details-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1500px) {
      .details-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .details-card { background: rgba(0,0,0,.28); border-radius:.7rem; padding:1rem; border:1px solid rgba(255,255,255,.10); box-shadow: 0 6px 18px rgba(0,0,0,.22); }
    .details-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
    .details-title { font-weight:700; letter-spacing:.2px; }
    .badges { display:flex; gap:.4rem; flex-wrap:wrap; }
    .badge { font-size:.72rem; padding:.12rem .5rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.22); background: rgba(255,255,255,.08); text-transform:uppercase; letter-spacing:.3px; }
    table.kv { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    table.kv col.kv-label { width:48%; }
    table.kv col.kv-value { width:52%; }
    table.kv td { padding:.42rem .45rem; border-bottom:1px dashed rgba(255,255,255,.12); vertical-align:top; }
    table.kv tr:last-child td { border-bottom:none; }
    .kv-label { color: rgba(255,255,255,.85); font-size:.9rem; }
    .kv-value { color:#fff; font-weight:600; font-size:.95rem; }
    .kv-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kv-sub { font-size:.85rem; font-weight:500; opacity:.9; }
    /* Two-column rows for stats tables */
    .row-grid-2 { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) { .row-grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .row-grid-2 + .row-grid-2 { margin-top: 1.25rem; }
    /* Unified stats grid for all six tables */
    .stats-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) { .stats-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .card { margin: 0; }
    /* Avoid inner cards touching the outer island outline */
    .card--full { width: auto; margin: .75rem; }
    /* Unified button styling (match main page "Run") */
    .btn, button, input[type="submit"], input[type="button"], a.btn {
      display:inline-block; padding:.65rem 1.4rem; border:none; border-radius:.7rem; background: var(--accent); color:#fff; cursor:pointer; text-decoration:none; box-shadow: 0 4px 14px rgba(31,182,184,.25); transition: background-color .2s ease, filter .15s ease, box-shadow .2s ease;
    }
    .btn:hover, button:hover, input[type="submit"]:hover, input[type="button"]:hover, a.btn:hover {
      filter: brightness(0.92); box-shadow: 0 6px 18px rgba(31,182,184,.32);
    }
    /* Header strip (reuse from home) */
    .header-strip { width: 100%; background: #060a0f; color: var(--text); border-bottom: 1px solid rgba(255,255,255,.08); padding: .7rem 0; margin-bottom: 2vh; }
    .brand { display:flex; align-items:center; gap: 1.25rem; }
    .brand-logo { height: 56px; width:auto; object-fit:contain; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); }
    .brand-text { display:flex; flex-direction:column; }
    .brand-title { font-size:1.6rem; font-weight:900 !important; font-variation-settings: "wght" 900; line-height:1.1; letter-spacing:.2px; }
    .brand-title strong { font-weight:900 !important; font-variation-settings: "wght" 900; }
    .brand-subtitle { opacity:.85; font-size:.98rem; }
  </style>
</head>
<body>
  <header class="header-strip">
    <div class="brand">
      <img src="/static/Images/pqc-bench-logo.png" alt="Post-Quantum Cryptography Bench" class="brand-logo" />
      <div class="brand-text">
        <div class="brand-title"><strong>Post-Quantum Cryptography Benchmarking</strong></div>
        <div class="brand-subtitle">Run and Compare Different Cryptographic Algorithms</div>
      </div>
    </div>
  </header>
  <div class="island" style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <div style="font-size:1.6rem; font-weight:700;">Compare Results – {{ compare.kind }}</div>
      <div style="opacity:.9;">Runs: {{ compare.runs }}{% if compare.kind=='SIG' %}, Message size: {{ compare.message_size }} B{% endif %} • Mode: {{ (compare.mode or 'cold')|capitalize }}</div>
      {% if compare.security_category is not none %}
        {% set cat_hint = {1:'≈ AES-128', 3:'≈ AES-192', 5:'≈ AES-256'} %}
        <div style="opacity:.85; font-size:.95rem;">Requested NIST Category {{ compare.security_category }} {{ cat_hint.get(compare.security_category, '') }}</div>
      {% endif %}
    </div>
    <div>
      <a href="/" class="btn">Back to setup</a>
    </div>
  </div>

  {% if errors and errors|length %}
  <div class="island" style="background: rgba(128,0,0,.35);">
    <div style="font-weight:700; margin-bottom:.5rem;">Some algorithms were skipped:</div>
    <ul>
    {% for name, msg in errors.items() %}
      <li><b>{{ name }}</b>: {{ msg }}</li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Algorithm Details -->
  <div class="island">
    <div style="font-weight:700; margin-bottom:.75rem;">Algorithm Details</div>
    <div class="details-grid">
      {% for a in compare.algos %}
      <div class="details-card">
        <div class="details-header">
          <div class="details-title">{{ a.label }}</div>
          <div class="badges">
            {% set algo_lower = a.name|lower %}
            {% set is_classical = 'rsa' in algo_lower %}
            <span class="badge">{{ 'Classical' if is_classical else 'PQC' }}</span>
            <span class="badge">{{ compare.kind }}</span>
          </div>
        </div>
        {% set backend = a.meta.backend if a.meta and a.meta.backend else '' %}
        {% if backend == 'liboqs' %}
          {% set backend_hint = 'liboqs (C via python-oqs)' %}
        {% elif backend == 'rsa' %}
          {% set backend_hint = 'cryptography/OpenSSL (classical)' %}
        {% elif backend == 'native' %}
          {% set backend_hint = 'native C backend (pqcbench_native)' %}
        {% else %}
          {% set backend_hint = 'unknown backend' %}
        {% endif %}
        <table class="kv">
          <colgroup>
            <col class="kv-label" />
            <col class="kv-value" />
          </colgroup>
          <tbody>
            <tr>
              <td class="kv-label">Version</td>
              <td class="kv-value">
                {% set version = '-' %}
                {% set m = a.meta %}
                {% if m %}
                  {% if 'mechanism' in m and m['mechanism'] %}{% set version = m['mechanism'] %}
                  {% elif 'algorithm' in m and m['algorithm'] %}{% set version = m['algorithm'] %}
                  {% elif 'alg' in m and m['alg'] %}{% set version = m['alg'] %}
                  {% elif 'mech' in m and m['mech'] %}{% set version = m['mech'] %}
                  {% elif 'version' in m and m['version'] %}{% set version = m['version'] %}
                  {% endif %}
                {% endif %}
                {{ version }}
              </td>
            </tr>
            {% set sec_meta = a.meta.get('security_level') if a.meta else None %}
            {% set sec_display = a.meta.get('security_level_display') if a.meta else None %}
            {% if sec_display or sec_meta %}
            <tr>
              <td class="kv-label">Security level</td>
              <td class="kv-value">
                {% if sec_display %}{{ sec_display }}{% else %}Category {{ sec_meta.applied_category or '-' }}{% endif %}
              </td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Backend</td>
              <td class="kv-value">{{ backend_hint }}</td>
            </tr>
            <tr>
              <td class="kv-label">Public key length</td>
              <td class="kv-value kv-mono">
                {% if a.meta.public_key_len is not none %}
                  {{ a.meta.public_key_len }} B ({{ a.meta.public_key_len * 8 }} bits)
                {% else %}-{% endif %}
              </td>
            </tr>
            <tr>
              <td class="kv-label">Secret key length</td>
              <td class="kv-value kv-mono">
                {% if a.meta.secret_key_len is not none %}
                  {{ a.meta.secret_key_len }} B ({{ a.meta.secret_key_len * 8 }} bits)
                {% else %}-{% endif %}
              </td>
            </tr>
            {% if compare.kind == 'KEM' %}
            <tr>
              <td class="kv-label">Ciphertext length</td>
              <td class="kv-value kv-mono">{% if a.meta.ciphertext_len is not none %}{{ a.meta.ciphertext_len }} B{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td class="kv-label">Shared secret length</td>
              <td class="kv-value kv-mono">{% if a.meta.shared_secret_len is not none %}{{ a.meta.shared_secret_len }} B{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td class="kv-label">CT expansion ratio (ct / shared secret)</td>
              <td class="kv-value">{% if a.meta.ciphertext_expansion_ratio is not none %}{{ '%.3f'|format(a.meta.ciphertext_expansion_ratio) }}{% else %}-{% endif %}</td>
            </tr>
            {% else %}
            <tr>
              <td class="kv-label">Signature length</td>
              <td class="kv-value kv-mono">{% if a.meta.signature_len is not none %}{{ a.meta.signature_len }} B{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td class="kv-label">Message size</td>
              <td class="kv-value kv-mono">{% if a.meta.message_size is not none %}{{ a.meta.message_size }} B{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td class="kv-label">Sig expansion ratio (sig / message)</td>
              <td class="kv-value">{% if a.meta.signature_expansion_ratio is not none %}{{ '%.3f'|format(a.meta.signature_expansion_ratio) }}{% else %}-{% endif %}</td>
            </tr>
            {% endif %}
            {% if a.meta.secret_key_analysis %}
            <tr>
              <td class="kv-label">Key analysis</td>
              <td class="kv-value">
                {% set ana = a.meta.secret_key_analysis %}
                {% if ana %}
                  {% set model = 'model' in ana and ana['model'] or None %}
                  {% set hw = 'hw' in ana and ana['hw'] or None %}
                  <div class="kv-sub">
                    {% if model %}
                      {% if model.name is defined %}<span>{{ model.name }}</span>{% else %}<span>{{ model }}</span>{% endif %}
                    {% endif %}
                    {% if 'bits_per_sample' in ana %}<span> · bits/sample: {{ ana['bits_per_sample'] }}</span>{% endif %}
                    {% if hw %}
                      <span> · HW mean: {% if hw['mean_fraction'] is not none %}{{ '%.4f'|format(hw['mean_fraction']) }}{% else %}-{% endif %}</span>
                      {% if hw and hw['expected_fraction'] is not none %}<span> (expected {{ '%.3f'|format(hw['expected_fraction']) }})</span>{% endif %}
                    {% endif %}
                  </div>
                {% else %}-{% endif %}
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing (ms)</div>
        <div id="timing-charts" class="grid"></div>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory (KB)</div>
        <div id="memory-charts" class="grid"></div>
      </div>
    </div>
  </div>

  

  <!-- Explicit Timing and Memory tables -->
  <div class="island">
    <div class="stats-grid">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Comparison Table (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} mean (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>{% if a.ops.get(op) %}{{ '%.3f'|format(a.ops[op].mean_ms) }}{% else %}-{% endif %}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Comparison Table (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} mem mean (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>
                  {% if a.ops.get(op) and a.ops[op].mem_mean_kb is not none %}
                    {{ '%.2f'|format(a.ops[op].mem_mean_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Standard Deviation (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} stddev (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>{% if a.ops.get(op) %}{{ '%.3f'|format(a.ops[op].stddev_ms) }}{% else %}-{% endif %}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Standard Deviation (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} stddev (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>
                  {% if a.ops.get(op) and a.ops[op].mem_stddev_kb is not none %}
                    {{ '%.2f'|format(a.ops[op].mem_stddev_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Median (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} median (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>{% if a.ops.get(op) %}{{ '%.3f'|format(a.ops[op].median_ms) }}{% else %}-{% endif %}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Median (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} median (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>
                  {% if a.ops.get(op) and a.ops[op].mem_median_kb is not none %}
                    {{ '%.2f'|format(a.ops[op].mem_median_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Additional statistics tables moved into the island above -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const data = {{ compare|tojson }};
      const ops = data.kind === 'KEM' ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
      const timingHost = document.getElementById('timing-charts');
      const memoryHost = document.getElementById('memory-charts');
      const palette = ['#1fb6b8', '#4d9dff', '#7ed957', '#ffd166', '#c792ea', '#00c2a8', '#f78c6c'];
      function makePanel(host, title){
        const wrap = document.createElement('div');
        wrap.style.background = 'rgba(0,0,0,.20)';
        wrap.style.padding = '.75rem';
        wrap.style.borderRadius = '.5rem';
        const h = document.createElement('div');
        h.textContent = title; h.style.fontWeight = '600'; h.style.marginBottom = '.5rem';
        wrap.appendChild(h);
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%'; canvas.style.height = '220px';
        wrap.appendChild(canvas);
        host.appendChild(wrap);
        return canvas.getContext('2d');
      }
      ops.forEach((op, opIndex) => {
        // Timing chart
        const ctxT = makePanel(timingHost, op.charAt(0).toUpperCase()+op.slice(1));
        const labels = (data.algos[0] && data.algos[0].ops[op]) ? data.algos[0].ops[op].series.map((_,i)=>i+1) : [];
        const tDatasets = data.algos.map((a,idx)=>({
          label: a.label,
          data: (a.ops[op] && a.ops[op].series) ? a.ops[op].series : [],
          borderColor: palette[idx % palette.length],
          backgroundColor: palette[idx % palette.length]+'33',
          tension: 0.25,
          pointRadius: 1.5,
          pointStyle: 'circle',
        }));
        new Chart(ctxT, { type:'line', data:{ labels, datasets: tDatasets }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10}}}, scales:{ x:{ ticks:{color:'#fff'}}, y:{ ticks:{color:'#fff'}} } } });

        // Memory chart
        const ctxM = makePanel(memoryHost, op.charAt(0).toUpperCase()+op.slice(1));
        const mDatasets = data.algos.map((a,idx)=>({
          label: a.label,
          data: (a.ops[op] && a.ops[op].mem_series_kb) ? a.ops[op].mem_series_kb : [],
          borderColor: palette[idx % palette.length],
          backgroundColor: palette[idx % palette.length]+'33',
          tension: 0.25,
          pointRadius: 1.5,
          pointStyle: 'circle',
        }));
        new Chart(ctxM, { type:'line', data:{ labels, datasets: mDatasets }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10}}}, scales:{ x:{ ticks:{color:'#fff'}}, y:{ ticks:{color:'#fff'}} } } });
      });
    })();
  </script>

  <!-- Secret-Key Hamming Distance section (between tables and AI) -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Secret-Key Hamming Distance (HD)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Mean fraction of differing bits between key pairs (per algorithm).</div>
        <canvas id="hd-bar" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">HD Statistics (fraction)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Samples</th>
              <th>Mean</th>
              <th>Stddev</th>
              <th>Min</th>
              <th>Max</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
            {% for a in compare.algos %}
            {% set ana = a.meta.secret_key_analysis if a.meta and a.meta.secret_key_analysis else None %}
            {% set hd = ana.hd if ana and ana.hd else None %}
            <tr>
              <td>{{ a.label }}</td>
              <td>{% if hd and hd.samples is not none %}{{ hd.samples }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.mean_fraction is not none %}{{ '%.4f'|format(hd.mean_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.std_fraction is not none %}{{ '%.4f'|format(hd.std_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.min_fraction is not none %}{{ '%.4f'|format(hd.min_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.max_fraction is not none %}{{ '%.4f'|format(hd.max_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.expected_fraction is not none %}{{ '%.4f'|format(hd.expected_fraction) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="hint" style="margin-top:.5rem; opacity:.85; font-size:.9rem;">Expected depends on scheme/family (e.g., ≈0.5 for uniform bits; HQC uses <code>2w(1 - w/n)/n</code>).</div>
        <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
          <strong>What is Hamming distance?</strong>
          The Hamming distance between two equal‑length bitstrings is the number of bit positions where they differ.
          Here we normalise it as a fraction in [0, 1] by dividing by the bit length. For each algorithm, we generate multiple
          secret keys and compute distances across sampled key pairs to summarise randomness properties. For truly uniform
          random keys, the expected fraction is ≈0.5 (half the bits differ on average). Some schemes (e.g., constant‑weight
          constructions like HQC’s secret vectors) have different expectations; in those cases the theoretical expected fraction is shown.
          Large deviations from expectation can indicate issues in key generation, encoding, or parameter handling.
        </div>
      </div>
    </div>
  </div>

  <!-- Secret-Key Hamming Weight section -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Secret-Key Hamming Weight (HW)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Mean fraction of 1-bits in secret keys (per algorithm).</div>
        <canvas id="hw-bar" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">HW Statistics (fraction)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Samples</th>
              <th>Mean</th>
              <th>Stddev</th>
              <th>Min</th>
              <th>Max</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            {% set ana = a.meta.secret_key_analysis if a.meta and a.meta.secret_key_analysis else None %}
            {% set hw = ana.hw if ana and ana.hw else None %}
            <tr>
              <td>{{ a.label }}</td>
              <td>{% if ana and compare and compare.runs is not none %}{{ ana.samples or '-' }}{% else %}{% if hw and hw.mean_fraction is not none %}{{ ana.samples or '-' }}{% else %}-{% endif %}{% endif %}</td>
              <td>{% if hw and hw.mean_fraction is not none %}{{ '%.4f'|format(hw.mean_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.std_fraction is not none %}{{ '%.4f'|format(hw.std_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.min_fraction is not none %}{{ '%.4f'|format(hw.min_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.max_fraction is not none %}{{ '%.4f'|format(hw.max_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.expected_fraction is not none %}{{ '%.4f'|format(hw.expected_fraction) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="hint" style="margin-top:.5rem; opacity:.85; font-size:.9rem;">Expected depends on scheme/family (uniform random bits ≈0.5; constant‑weight secrets use <code>w/n</code> where <code>w</code> is the weight and <code>n</code> the length).</div>
        <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
          <strong>What is Hamming weight?</strong>
          The Hamming weight of a bitstring is the number of 1‑bits it contains. Normalising by bit length gives a fraction in [0, 1].
          For uniformly random secrets, the expected fraction is ≈0.5. Some constructions are not uniform; for example, constant‑weight
          schemes fix exactly <em>w</em> ones among <em>n</em> bits so the expected fraction is <em>w/n</em>. Comparing observed vs expected
          helps flag RNG or encoding anomalies in key generation.
        </div>
      </div>
    </div>
  </div>

  <!-- Security Analysis section -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Classical Security (bits)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Estimated classical attack cost per algorithm.</div>
        <canvas id="sec-classical" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Quantum Security (bits)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Estimated quantum attack cost per algorithm.</div>
        <canvas id="sec-quantum" style="width:100%; height:260px;"></canvas>
      </div>
    </div>
    <div class="card" style="margin-top:1.25rem;">
      <div style="font-weight:700; margin-bottom:.5rem;">Security Summary</div>
      <table class="vlines">
        <thead>
          <tr>
            <th>Algorithm</th>
            <th>NIST category</th>
            <th>Category floor</th>
            <th>Classical bits</th>
            <th>Quantum bits</th>
            <th>Shor breakable</th>
            <th>Estimator</th>
          </tr>
        </thead>
        <tbody>
          {% for a in compare.algos %}
          {% set s = a.security if a.security else {} %}
          {% set est = s.estimator if s and s.estimator else {} %}
          <tr>
            <td>{{ a.label }}</td>
            <td>{% if s.nist_category is not none %}{{ s.nist_category }}{% else %}-{% endif %}</td>
            <td>{% if s.category_floor is not none %}{{ s.category_floor }}{% else %}-{% endif %}</td>
            <td>{% if s.classical_bits is number %}{{ '%.2f'|format(s.classical_bits) }}{% else %}-{% endif %}</td>
            <td>{% if s.quantum_bits is number %}{{ '%.2f'|format(s.quantum_bits) }}{% else %}-{% endif %}</td>
            <td>
              {% if s.shor_breakable is not none %}
                {% if s.shor_breakable %}<span style="color:#ffb3b3;">Yes</span>{% else %}<span style="color:#b3ffb3;">No</span>{% endif %}
              {% else %}-{% endif %}
            </td>
            <td>{% if est.name %}{{ est.name }}{% else %}-{% endif %}{% if est.profile %} <span class="kv-sub">({{ est.profile }})</span>{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
        <strong>How to read this:</strong> “Bits” are estimated work factors: higher is better (harder to break). Classical bits approximate cost under classical attacks; quantum bits under realistic quantum models. “Shor breakable” highlights schemes vulnerable to Shor’s algorithm (e.g., RSA, ECC). Values depend on estimator settings (profile, physical error rates, etc.).
      </div>
    </div>
  </div>

  <script>
    (function(){
      const data = {{ compare|tojson }};
      const algos = Array.isArray(data.algos) ? data.algos : [];
      const labels = [];
      const classical = [];
      const quantum = [];
      for (const a of algos) {
        const s = a && a.security || {};
        const cb = (typeof s.classical_bits === 'number') ? s.classical_bits : null;
        const qb = (typeof s.quantum_bits === 'number') ? s.quantum_bits : null;
        labels.push(a.label || a.name || '?');
        classical.push(cb);
        quantum.push(qb);
      }
      function buildBar(elId, ds, color, title){
        const el = document.getElementById(elId);
        if (!el) return;
        const filtered = ds.map((v) => (typeof v === 'number' ? v : null));
        if (filtered.every(v => v == null)) {
          const msg = document.createElement('div');
          msg.textContent = 'No data available.';
          msg.style.opacity = '0.9';
          msg.style.fontSize = '.95rem';
          el.parentElement.appendChild(msg);
          return;
        }
        try {
          const ctx = el.getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{ label: title, data: filtered, backgroundColor: color }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Bits' }, ticks: { color:'#fff' } },
                x: { ticks: { color:'#fff' } }
              },
              plugins: { legend: { display: false } },
              animation: false,
              normalized: true,
            }
          });
        } catch (e) {}
      }
      buildBar('sec-classical', classical, '#4d9dff', 'Classical bits');
      buildBar('sec-quantum', quantum, '#c792ea', 'Quantum bits');
    })();
  </script>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const el = document.getElementById('hd-bar');
      if (!el || !compareData || !Array.isArray(compareData.algos)) return;
      const rows = [];
      for (const a of compareData.algos) {
        const ana = a && a.meta && a.meta.secret_key_analysis;
        const hd = ana && ana.hd;
        if (hd && hd.mean_fraction != null) {
          rows.push({
            label: a.label || a.name || '?',
            mean: +hd.mean_fraction,
            exp: (hd.expected_fraction != null ? +hd.expected_fraction : null)
          });
        }
      }
      if (!rows.length) {
        // No data: show a subtle message
        const msg = document.createElement('div');
        msg.textContent = 'No HD data available for the selected algorithms.';
        msg.style.opacity = '0.9';
        msg.style.fontSize = '.95rem';
        el.parentElement.appendChild(msg);
        return;
      }
      const labels = rows.map(r => r.label);
      const means = rows.map(r => r.mean);
      const expects = rows.map(r => r.exp);
      const hasAnyExpected = expects.some(v => v != null);
      try {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'HD mean fraction',
                data: means,
                backgroundColor: '#1fb6b8',
              },
              ...(hasAnyExpected ? [{
                label: 'Expected fraction',
                data: expects,
                backgroundColor: '#ffd166',
                borderColor: '#ffd166',
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'Fraction' },
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 1,
                ticks: { color: '#fff', callback: (v) => (typeof v === 'number' ? v.toFixed(2) : v) }
              },
              x: { ticks: { color: '#fff' } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
              tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(4) : ctx.parsed.y) } }
            },
            animation: false,
            normalized: true,
          }
        });
      } catch (e) { /* ignore */ }
    })();
  </script>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const el = document.getElementById('hw-bar');
      if (!el || !compareData || !Array.isArray(compareData.algos)) return;
      const rows = [];
      for (const a of compareData.algos) {
        const ana = a && a.meta && a.meta.secret_key_analysis;
        const hw = ana && ana.hw;
        if (hw && hw.mean_fraction != null) {
          rows.push({
            label: a.label || a.name || '?',
            mean: +hw.mean_fraction,
            exp: (hw.expected_fraction != null ? +hw.expected_fraction : null)
          });
        }
      }
      if (!rows.length) {
        const msg = document.createElement('div');
        msg.textContent = 'No HW data available for the selected algorithms.';
        msg.style.opacity = '0.9';
        msg.style.fontSize = '.95rem';
        el.parentElement.appendChild(msg);
        return;
      }
      const labels = rows.map(r => r.label);
      const means = rows.map(r => r.mean);
      const expects = rows.map(r => r.exp);
      const hasAnyExpected = expects.some(v => v != null);
      try {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'HW mean fraction',
                data: means,
                backgroundColor: '#7ed957',
              },
              ...(hasAnyExpected ? [{
                label: 'Expected fraction',
                data: expects,
                backgroundColor: '#ffd166',
                borderColor: '#ffd166',
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'Fraction' },
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 1,
                ticks: { color: '#fff', callback: (v) => (typeof v === 'number' ? v.toFixed(2) : v) }
              },
              x: { ticks: { color: '#fff' } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
              tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(4) : ctx.parsed.y) } }
            },
            animation: false,
            normalized: true,
          }
        });
      } catch (e) { /* ignore */ }
    })();
  </script>

  <!-- LLM Analysis section (appears before Raw Exports) -->
  <div class="island">
    <div class="card card--full" style="display:flex; flex-direction:column; gap:.6rem;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
        <div style="font-weight:700;">AI-Assisted Analysis</div>
        <div style="opacity:.9; font-size:.9rem;">
          <span id="llm-provider-hint">Provider: auto (configurable)</span>
        </div>
      </div>
      <div id="llm-analysis-output" style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.5rem; min-height: 80px; white-space:pre-wrap; line-height:1.35;">
        Click "Generate Analysis" to summarize these results.
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; align-items:center;">
        <button id="llm-generate" type="button">Generate Analysis</button>
        <button id="llm-regenerate" type="button" style="display:none;" class="btn">Regenerate</button>
      </div>
      <div id="llm-analysis-error" style="display:none; color:#ffdddd; background:#902; padding:.5rem .75rem; border-radius:.4rem;"></div>
    </div>
  </div>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const out = document.getElementById('llm-analysis-output');
      const btn = document.getElementById('llm-generate');
      const btnRe = document.getElementById('llm-regenerate');
      const err = document.getElementById('llm-analysis-error');
      const hint = document.getElementById('llm-provider-hint');

      async function runAnalysis() {
        err.style.display = 'none';
        err.textContent = '';
        btn.disabled = true; btnRe.disabled = true;
        const prev = out.textContent;
        out.textContent = 'Generating analysis...';
        try {
          const res = await fetch('/api/analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compare: compareData })
          });
          const data = await res.json();
          if (!data || data.ok === false) {
            throw new Error((data && data.error) || 'Analysis failed');
          }
          const provider = (data.provider || 'auto');
          const model = (data.model || '');
          const usedFallback = !!data.used_fallback;
          if (hint) {
            hint.textContent = 'Provider: ' + provider + (model ? (' • ' + model) : '') + (usedFallback ? ' (fallback)' : '');
          }
          out.textContent = (data.analysis || '').trim() || 'No analysis returned.';
          btnRe.style.display = 'inline-block';
        } catch (e) {
          out.textContent = prev;
          err.style.display = 'block';
          err.textContent = String(e);
        } finally {
          btn.disabled = false; btnRe.disabled = false;
        }
      }

      btn.addEventListener('click', runAnalysis);
      btnRe.addEventListener('click', runAnalysis);
      // Auto-run once when the section loads
      try { runAnalysis(); } catch (e) {}
    })();
  </script>

  <!-- Raw exports section -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Raw Exports</div>
      <details style="margin-top:.25rem;">
        <summary style="cursor:pointer;">View raw JSON</summary>
        <div style="margin-top:.6rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem;">
          {% for a in compare.algos %}
          <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.5rem; text-align:left;">
            <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
            {% set ex = a.exports if a.exports else (a.meta.exports if a.meta and a.meta.exports else None) %}
            {% if ex and ex.json %}
              <div><a href="/{{ ex.json }}" target="_blank" style="color:#aee; text-decoration:underline;">Open JSON summary</a></div>
            {% else %}
              <div style="opacity:.8;">No JSON export available.</div>
            {% endif %}
            {% set inline_export = { 'algo': a.name, 'kind': compare.kind, 'ops': a.ops, 'meta': a.meta } %}
            {% if a.meta and a.meta.validation %}
              {% set _ = inline_export.update({'validation': a.meta.validation}) %}
            {% endif %}
            <details style="margin-top:.5rem;">
              <summary style="cursor:pointer;">Inline JSON</summary>
              <pre style="white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,0.3); padding:0.75rem; border-radius:0.5rem; max-height:40vh; overflow:auto; margin-top:.45rem;">{{ inline_export | tojson(indent=2) }}</pre>
            </details>
          </div>
          {% endfor %}
        </div>
      </details>

      <details style="margin-top:1rem;">
        <summary style="cursor:pointer;">View raw data (one run)</summary>
        <div style="margin-top:.6rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem;">
          {% for a in compare.algos %}
          <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.5rem; text-align:left;">
            <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
            {% set ex = a.exports if a.exports else (a.meta.exports if a.meta and a.meta.exports else None) %}
            {% if ex and ex.trace %}
              <div><a href="/{{ ex.trace }}" target="_blank" style="color:#aee; text-decoration:underline;">Open raw trace</a></div>
            {% else %}
              <div style="opacity:.8;">No trace export available.</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </details>
    </div>
  </div>
</body>
</html>
