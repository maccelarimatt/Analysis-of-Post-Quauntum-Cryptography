<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PQC Bench – Compare Results</title>
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" sizes="any" />
  <link rel="mask-icon" href="/static/favicon.svg" color="#1fb6b8" />
  <link rel="apple-touch-icon" href="/static/Images/pqc-bench-logo.png" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root { --island-bg: rgba(38,41,45,.92); --island-radius:1.5rem; --text:#fff; --accent:#1fb6b8; }
    /* Reduce top padding so header sits closer to top */
    body { margin:0; padding:0.1vh 5vw 5vh; color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; background-image:url('/static/Images/background.gif'); background-size:cover; background-position:center; background-repeat:no-repeat; background-attachment:fixed; }
    .island { background:var(--island-bg); border-radius:var(--island-radius); padding:1.25rem; backdrop-filter: blur(4px); max-width:1200px; margin:0 auto 1.6vh auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; }
    .card { background: rgba(0,0,0,.25); border-radius:.75rem; padding:1rem; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:.45rem .35rem; border-bottom: 1px dashed rgba(255,255,255,.2); }
    /* Vertical lines between columns for comparison tables */
    table.vlines th:not(:last-child),
    table.vlines td:not(:last-child) { border-right: 1px solid rgba(255,255,255,.25); }
    table.vlines thead th { border-bottom: 1px solid rgba(255,255,255,.35); }

    /* Refined details layout */
    /* Layout: fewer cards per row for better readability */
    .details-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) {
      .details-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1500px) {
      .details-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .details-card { background: rgba(0,0,0,.28); border-radius:.7rem; padding:1rem; border:1px solid rgba(255,255,255,.10); box-shadow: 0 6px 18px rgba(0,0,0,.22); }
    .details-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
    .details-title { font-weight:700; letter-spacing:.2px; }
    .badges { display:flex; gap:.4rem; flex-wrap:wrap; }
    .badge { font-size:.72rem; padding:.12rem .5rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.22); background: rgba(255,255,255,.08); text-transform:uppercase; letter-spacing:.3px; }
    table.kv { width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    table.kv col.kv-label { width:48%; }
    table.kv col.kv-value { width:52%; }
    table.kv td { padding:.42rem .45rem; border-bottom:1px dashed rgba(255,255,255,.12); vertical-align:top; }
    table.kv tr:last-child td { border-bottom:none; }
    .kv-label { color: rgba(255,255,255,.85); font-size:.9rem; }
    .kv-value { color:#fff; font-weight:600; font-size:.95rem; }
    .kv-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kv-sub { font-size:.85rem; font-weight:500; opacity:.9; }
    /* Two-column rows for stats tables */
    .row-grid-2 { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) { .row-grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .row-grid-2 + .row-grid-2 { margin-top: 1.25rem; }
    /* Unified stats grid for all six tables */
    .stats-grid { display:grid; grid-template-columns: 1fr; gap:1.25rem; }
    @media (min-width: 900px) { .stats-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .card { margin: 0; }
    /* Avoid inner cards touching the outer island outline */
    .card--full { width: auto; margin: .75rem; }
    /* Unified button styling (match main page "Run") */
    .btn, button, input[type="submit"], input[type="button"], a.btn {
      display:inline-block; padding:.65rem 1.4rem; border:none; border-radius:.7rem; background: var(--accent); color:#fff; cursor:pointer; text-decoration:none; box-shadow: 0 4px 14px rgba(31,182,184,.25); transition: background-color .2s ease, filter .15s ease, box-shadow .2s ease;
    }
    .btn:hover, button:hover, input[type="submit"]:hover, input[type="button"]:hover, a.btn:hover {
      filter: brightness(0.92); box-shadow: 0 6px 18px rgba(31,182,184,.32);
    }
    /* Header strip (reuse from home) */
    .header-strip { width: 100%; background: #060a0f; color: var(--text); border-bottom: 1px solid rgba(255,255,255,.08); padding: .7rem 0; margin-bottom: 2vh; }
    .brand { display:flex; align-items:center; gap: 1.25rem; }
    .brand-logo { height: 56px; width:auto; object-fit:contain; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); }
    .brand-text { display:flex; flex-direction:column; }
    .brand-title { font-size:1.6rem; font-weight:900 !important; font-variation-settings: "wght" 900; line-height:1.1; letter-spacing:.2px; }
    .brand-title strong { font-weight:900 !important; font-variation-settings: "wght" 900; }
    .brand-subtitle { opacity:.85; font-size:.98rem; }
  </style>
</head>
<body>
  <header class="header-strip">
    <div class="brand">
      <img src="/static/Images/pqc-bench-logo.png" alt="Post-Quantum Cryptography Bench" class="brand-logo" />
      <div class="brand-text">
        <div class="brand-title"><strong>Post-Quantum Cryptography Benchmarking</strong></div>
        <div class="brand-subtitle">Run and Compare Different Cryptographic Algorithms</div>
      </div>
    </div>
  </header>
  <div class="island" style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <div style="font-size:1.6rem; font-weight:700;">Compare Results – {{ compare.kind }}</div>
      <div style="opacity:.9;">Runs: {{ compare.runs }}{% if compare.kind=='SIG' %}, Message size: {{ compare.message_size }} B{% endif %} • Mode: {{ (compare.mode or 'cold')|capitalize }}</div>
      {% if compare.security_category is not none %}
        {% set cat_hint = {1:'≈ AES-128', 3:'≈ AES-192', 5:'≈ AES-256'} %}
        <div style="opacity:.85; font-size:.95rem;">Requested NIST Category {{ compare.security_category }} {{ cat_hint.get(compare.security_category, '') }}</div>
      {% endif %}
    </div>
    <div>
      <a href="/" class="btn">Back to setup</a>
    </div>
  </div>

  {% if errors and errors|length %}
  <div class="island" style="background: rgba(128,0,0,.35);">
    <div style="font-weight:700; margin-bottom:.5rem;">Some algorithms were skipped:</div>
    <ul>
    {% for name, msg in errors.items() %}
      <li><b>{{ name }}</b>: {{ msg }}</li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}

  <!-- Algorithm Details -->
  <div class="island">
    <div style="font-weight:700; margin-bottom:.75rem;">Algorithm Details</div>
    <div class="details-grid">
      {% for a in compare.algos %}
      <div class="details-card">
        <div class="details-header">
          <div class="details-title">{{ a.label }}</div>
          <div class="badges">
            {% set algo_lower = a.name|lower %}
            {% set is_classical = 'rsa' in algo_lower %}
            <span class="badge">{{ 'Classical' if is_classical else 'PQC' }}</span>
            <span class="badge">{{ compare.kind }}</span>
          </div>
        </div>
        {% set backend = a.meta.backend if a.meta and a.meta.backend else '' %}
        {% if backend == 'liboqs' %}
          {% set backend_hint = 'liboqs (C via python-oqs)' %}
        {% elif backend == 'rsa' %}
          {% set backend_hint = 'cryptography/OpenSSL (classical)' %}
        {% elif backend == 'native' %}
          {% set backend_hint = 'native C backend (pqcbench_native)' %}
        {% else %}
          {% set backend_hint = 'unknown backend' %}
        {% endif %}
        <table class="kv">
          <colgroup>
            <col class="kv-label" />
            <col class="kv-value" />
          </colgroup>
          <tbody>
            {% set sec_obj = a.security or {} %}
            {% set sec_params = sec_obj.get('parameters', {}) %}
            {% set canonical_sizes = sec_params.get('sizes_bytes') %}
            <tr>
              <td class="kv-label">Version</td>
              <td class="kv-value">
                {% set version = '-' %}
                {% set m = a.meta %}
                {% if m %}
                  {% if 'mechanism' in m and m['mechanism'] %}{% set version = m['mechanism'] %}
                  {% elif 'algorithm' in m and m['algorithm'] %}{% set version = m['algorithm'] %}
                  {% elif 'alg' in m and m['alg'] %}{% set version = m['alg'] %}
                  {% elif 'mech' in m and m['mech'] %}{% set version = m['mech'] %}
                  {% elif 'version' in m and m['version'] %}{% set version = m['version'] %}
                  {% endif %}
                {% endif %}
                {{ version }}
              </td>
            </tr>
            {% set sec_meta = a.meta.get('security_level') if a.meta else None %}
            {% set sec_display = a.meta.get('security_level_display') if a.meta else None %}
            {% if sec_display or sec_meta %}
            <tr>
              <td class="kv-label">Security level</td>
              <td class="kv-value">
                {% if sec_display %}{{ sec_display }}{% else %}Category {{ sec_meta.applied_category or '-' }}{% endif %}
              </td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Backend</td>
              <td class="kv-value">{{ backend_hint }}</td>
            </tr>
            <tr>
              <td class="kv-label">Public key length</td>
              <td class="kv-value kv-mono">
                {% if a.meta.public_key_len is not none %}
                  {{ a.meta.public_key_len }} B ({{ a.meta.public_key_len * 8 }} bits)
                {% else %}-{% endif %}
              </td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('public_key') %}
            <tr>
              <td class="kv-label">Spec public key length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('public_key') }} B</td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Secret key length</td>
              <td class="kv-value kv-mono">
                {% if a.meta.secret_key_len is not none %}
                  {{ a.meta.secret_key_len }} B ({{ a.meta.secret_key_len * 8 }} bits)
                {% else %}-{% endif %}
              </td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('secret_key') %}
            <tr>
              <td class="kv-label">Spec secret key length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('secret_key') }} B</td>
            </tr>
            {% endif %}
            {% if compare.kind == 'KEM' %}
            <tr>
              <td class="kv-label">Ciphertext length</td>
              <td class="kv-value kv-mono">{% if a.meta.ciphertext_len is not none %}{{ a.meta.ciphertext_len }} B{% else %}-{% endif %}</td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('ciphertext') %}
            <tr>
              <td class="kv-label">Spec ciphertext length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('ciphertext') }} B</td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Shared secret length</td>
              <td class="kv-value kv-mono">{% if a.meta.shared_secret_len is not none %}{{ a.meta.shared_secret_len }} B{% else %}-{% endif %}</td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('shared_secret') %}
            <tr>
              <td class="kv-label">Spec shared secret length</td>
              <td class="kv-value kv-mono">{{ canonical_sizes.get('shared_secret') }} B</td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">CT expansion ratio (ct / shared secret)</td>
              <td class="kv-value">{% if a.meta.ciphertext_expansion_ratio is not none %}{{ '%.3f'|format(a.meta.ciphertext_expansion_ratio) }}{% else %}-{% endif %}</td>
            </tr>
            {% else %}
            <tr>
              <td class="kv-label">Signature length</td>
              <td class="kv-value kv-mono">{% if a.meta.signature_len is not none %}{{ a.meta.signature_len }} B{% else %}-{% endif %}</td>
            </tr>
            {% if canonical_sizes and canonical_sizes.get('signature') %}
            <tr>
              <td class="kv-label">Spec signature length</td>
              <td class="kv-value kv-mono">
                {{ canonical_sizes.get('signature') }} B
                {% if canonical_sizes.get('signature_min') %}
                  <div class="kv-sub">Min {{ canonical_sizes.get('signature_min') }} B</div>
                {% endif %}
                {% if canonical_sizes.get('signature_note') %}
                  <div class="kv-sub">{{ canonical_sizes.get('signature_note') }}</div>
                {% endif %}
              </td>
            </tr>
            {% endif %}
            <tr>
              <td class="kv-label">Message size</td>
              <td class="kv-value kv-mono">{% if a.meta.message_size is not none %}{{ a.meta.message_size }} B{% else %}-{% endif %}</td>
            </tr>
            <tr>
              <td class="kv-label">Sig expansion ratio (sig / message)</td>
              <td class="kv-value">{% if a.meta.signature_expansion_ratio is not none %}{{ '%.3f'|format(a.meta.signature_expansion_ratio) }}{% else %}-{% endif %}</td>
            </tr>
            {% endif %}
            {% if a.meta.secret_key_analysis %}
            <tr>
              <td class="kv-label">Key analysis</td>
              <td class="kv-value">
                {% set ana = a.meta.secret_key_analysis %}
                {% if ana %}
                  {% set model = 'model' in ana and ana['model'] or None %}
                  {% set hw = 'hw' in ana and ana['hw'] or None %}
                  <div class="kv-sub">
                    {% if model %}
                      {% if model.name is defined %}<span>{{ model.name }}</span>{% else %}<span>{{ model }}</span>{% endif %}
                    {% endif %}
                    {% if 'bits_per_sample' in ana %}<span> · bits/sample: {{ ana['bits_per_sample'] }}</span>{% endif %}
                    {% if hw %}
                      <span> · HW mean: {% if hw['mean_fraction'] is not none %}{{ '%.4f'|format(hw['mean_fraction']) }}{% else %}-{% endif %}</span>
                      {% if hw and hw['expected_fraction'] is not none %}<span> (expected {{ '%.3f'|format(hw['expected_fraction']) }})</span>{% endif %}
                    {% endif %}
                  </div>
                {% else %}-{% endif %}
              </td>
            </tr>
            {% endif %}
            {% set val = a.meta.validation if a.meta and a.meta.validation else None %}
            {% if val %}
            <tr>
              <td class="kv-label">Validation</td>
              <td class="kv-value">
                {% set status = val.status or '-' %}
                {% set cases = val.cases if val.cases is not none else '-' %}
                {% set passes = val.passes if val.passes is not none else '-' %}
                {% set fails = val.fails if val.fails is not none else '-' %}
                <span class="kv-sub">{{ status }}</span> — cases: {{ cases }}, passes: {{ passes }}, fails: {{ fails }}
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing (ms)</div>
        <div id="timing-charts" class="grid"></div>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory (KB)</div>
        <div id="memory-charts" class="grid"></div>
      </div>
    </div>
  </div>

  

  <!-- Explicit Timing and Memory tables -->
  <div class="island">
    <div class="stats-grid">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Comparison Table (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} mean (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>{% if a.ops.get(op) %}{{ '%.3f'|format(a.ops[op].mean_ms) }}{% else %}-{% endif %}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Comparison Table (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} mem mean (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>
                  {% if a.ops.get(op) and a.ops[op].mem_mean_kb is not none %}
                    {{ '%.2f'|format(a.ops[op].mem_mean_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Standard Deviation (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} stddev (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>{% if a.ops.get(op) %}{{ '%.3f'|format(a.ops[op].stddev_ms) }}{% else %}-{% endif %}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Standard Deviation (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} stddev (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>
                  {% if a.ops.get(op) and a.ops[op].mem_stddev_kb is not none %}
                    {{ '%.2f'|format(a.ops[op].mem_stddev_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Median (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} median (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>{% if a.ops.get(op) %}{{ '%.3f'|format(a.ops[op].median_ms) }}{% else %}-{% endif %}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Median (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} median (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                <td>
                  {% if a.ops.get(op) and a.ops[op].mem_median_kb is not none %}
                    {{ '%.2f'|format(a.ops[op].mem_median_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Confidence Intervals and Min/Max tables -->
  <div class="island">
    <div class="stats-grid">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing 95% CI (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} CI95 (ms)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s and s.ci95_low_ms is not none and s.ci95_high_ms is not none %}
                    {{ '%.3f'|format(s.ci95_low_ms) }} – {{ '%.3f'|format(s.ci95_high_ms) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory 95% CI (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} CI95 (KB)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s and s.mem_ci95_low_kb is not none and s.mem_ci95_high_kb is not none %}
                    {{ '%.2f'|format(s.mem_ci95_low_kb) }} – {{ '%.2f'|format(s.mem_ci95_high_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Timing Min/Max/Range (ms)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} (min/max/range)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s %}
                    {{ '%.3f'|format(s.min_ms) }} / {{ '%.3f'|format(s.max_ms) }} / {{ '%.3f'|format(s.range_ms) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Memory Min/Max/Range (KB)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
              {% for op in ops %}
                <th>{{ op|capitalize }} (min/max/range)</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            <tr>
              <td>{{ a.label }}</td>
              {% for op in ops %}
                {% set s = a.ops.get(op) %}
                <td>
                  {% if s and s.mem_min_kb is not none and s.mem_max_kb is not none and s.mem_range_kb is not none %}
                    {{ '%.2f'|format(s.mem_min_kb) }} / {{ '%.2f'|format(s.mem_max_kb) }} / {{ '%.2f'|format(s.mem_range_kb) }}
                  {% else %}-{% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Benchmark Environment summary (from first algorithm) -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Benchmark Environment</div>
      {% set ns = namespace(env=None, done=false) %}
      {% for a in compare.algos %}
        {% if not ns.done and a.meta and a.meta.environment %}
          {% set ns.env = a.meta.environment %}
          {% set ns.done = true %}
        {% endif %}
      {% endfor %}
      {% set env = ns.env %}
      {% if env %}
        <div class="grid" style="gap:.75rem;">
          <div class="card">
            <div style="font-weight:600; margin-bottom:.35rem;">Host</div>
            <table class="kv">
              <tbody>
                <tr><td class="kv-label">CPU</td><td class="kv-value">{{ env.cpu_model or '-' }}</td></tr>
                <tr><td class="kv-label">OS</td><td class="kv-value">{{ env.os or '-' }}</td></tr>
                <tr><td class="kv-label">Python</td><td class="kv-value">{{ env.python or '-' }}</td></tr>
              </tbody>
            </table>
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.35rem;">Dependencies</div>
            {% set deps = env.dependencies if env.dependencies else None %}
            {% if deps %}
            <table class="kv"><tbody>
              {% for k, v in deps.items() %}
                {% set v_str = v|string %}
                <tr>
                  <td class="kv-label">{{ k }}</td>
                  <td class="kv-value kv-mono">
                    <span title="{{ v_str }}">{{ v_str[:12] }}{% if v_str|length > 12 %}…{% endif %}</span>
                    <button type="button" data-copy="{{ v_str }}" style="margin-left:.5rem; padding:.2rem .5rem; font-size:.75rem; border-radius:.35rem; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); color:#fff;">Copy</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody></table>
            {% else %}
              <div class="kv-sub">No dependency metadata recorded.</div>
            {% endif %}
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.35rem;">Build Flags</div>
            {% set bf = env.build_flags if env.build_flags else None %}
            {% if bf %}
              {% for k, flags in bf.items() %}
                {% set block_id = 'bf_' ~ loop.index0 ~ '_' ~ k %}
                <details style="margin:.35rem 0;">
                  <summary style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                    <span>{{ k }} <span class="kv-sub">({{ flags|length }} entries)</span></span>
                    <button type="button" data-copy-target="{{ block_id }}" style="padding:.25rem .6rem; font-size:.78rem; border-radius:.35rem; background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25); color:#fff;">Copy JSON</button>
                  </summary>
                  <pre id="{{ block_id }}" style="margin-top:.35rem; background:rgba(0,0,0,0.3); padding:.6rem .7rem; border-radius:.5rem; max-height:220px; overflow:auto;">{{ flags | tojson(indent=2) }}</pre>
                </details>
              {% endfor %}
            {% else %}
              <div class="kv-sub">No build flags recorded.</div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="kv-sub">Environment metadata unavailable.</div>
      {% endif %}
    </div>
  </div>

  <script>
    // Lightweight copy helpers for environment cards
    (function(){
      function copyText(txt){
        if (!txt) return;
        try { navigator.clipboard.writeText(txt); } catch(e) { /* ignore */ }
      }
      function copyFromEl(id){
        var el = document.getElementById(id);
        if (!el) return;
        var t = el.innerText || el.textContent || '';
        copyText(t);
      }
      document.addEventListener('click', function(ev){
        var btn = ev.target;
        if (btn && btn.getAttribute) {
          var v = btn.getAttribute('data-copy');
          if (v != null) { copyText(v); }
          var id = btn.getAttribute('data-copy-target');
          if (id) { copyFromEl(id); }
        }
      }, false);
    })();
  </script>

  <!-- Additional statistics tables moved into the island above -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const data = {{ compare|tojson }};
      const ops = data.kind === 'KEM' ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
      const timingHost = document.getElementById('timing-charts');
      const memoryHost = document.getElementById('memory-charts');
      const palette = ['#1fb6b8', '#4d9dff', '#7ed957', '#ffd166', '#c792ea', '#00c2a8', '#f78c6c'];
      function makePanel(host, title){
        const wrap = document.createElement('div');
        wrap.style.background = 'rgba(0,0,0,.20)';
        wrap.style.padding = '.75rem';
        wrap.style.borderRadius = '.5rem';
        const h = document.createElement('div');
        h.textContent = title; h.style.fontWeight = '600'; h.style.marginBottom = '.5rem';
        wrap.appendChild(h);
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%'; canvas.style.height = '220px';
        wrap.appendChild(canvas);
        host.appendChild(wrap);
        return canvas.getContext('2d');
      }
      ops.forEach((op, opIndex) => {
        // Timing chart
        const ctxT = makePanel(timingHost, op.charAt(0).toUpperCase()+op.slice(1));
        const labels = (data.algos[0] && data.algos[0].ops[op]) ? data.algos[0].ops[op].series.map((_,i)=>i+1) : [];
        const tDatasets = data.algos.map((a,idx)=>({
          label: a.label,
          data: (a.ops[op] && a.ops[op].series) ? a.ops[op].series : [],
          borderColor: palette[idx % palette.length],
          backgroundColor: palette[idx % palette.length]+'33',
          tension: 0.25,
          pointRadius: 1.5,
          pointStyle: 'circle',
        }));
        new Chart(ctxT, { type:'line', data:{ labels, datasets: tDatasets }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10}}}, scales:{ x:{ ticks:{color:'#fff'}}, y:{ ticks:{color:'#fff'}} } } });

        // Memory chart
        const ctxM = makePanel(memoryHost, op.charAt(0).toUpperCase()+op.slice(1));
        const mDatasets = data.algos.map((a,idx)=>({
          label: a.label,
          data: (a.ops[op] && a.ops[op].mem_series_kb) ? a.ops[op].mem_series_kb : [],
          borderColor: palette[idx % palette.length],
          backgroundColor: palette[idx % palette.length]+'33',
          tension: 0.25,
          pointRadius: 1.5,
          pointStyle: 'circle',
        }));
        new Chart(ctxM, { type:'line', data:{ labels, datasets: mDatasets }, options:{ responsive:true, plugins:{legend:{position:'bottom', labels:{color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10}}}, scales:{ x:{ ticks:{color:'#fff'}}, y:{ ticks:{color:'#fff'}} } } });
      });
    })();
  </script>

  <!-- Secret-Key Hamming Distance section (between tables and AI) -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Secret-Key Hamming Distance (HD)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Mean fraction of differing bits between key pairs (per algorithm).</div>
        <canvas id="hd-bar" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">HD Statistics (fraction)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Samples</th>
              <th>Mean</th>
              <th>Stddev</th>
              <th>Min</th>
              <th>Max</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% set ops = ['keygen','encapsulate','decapsulate'] if compare.kind=='KEM' else ['keygen','sign','verify'] %}
            {% for a in compare.algos %}
            {% set ana = a.meta.secret_key_analysis if a.meta and a.meta.secret_key_analysis else None %}
            {% set hd = ana.hd if ana and ana.hd else None %}
            <tr>
              <td>{{ a.label }}</td>
              <td>{% if hd and hd.samples is not none %}{{ hd.samples }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.mean_fraction is not none %}{{ '%.4f'|format(hd.mean_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.std_fraction is not none %}{{ '%.4f'|format(hd.std_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.min_fraction is not none %}{{ '%.4f'|format(hd.min_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.max_fraction is not none %}{{ '%.4f'|format(hd.max_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hd and hd.expected_fraction is not none %}{{ '%.4f'|format(hd.expected_fraction) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="hint" style="margin-top:.5rem; opacity:.85; font-size:.9rem;">Expected depends on scheme/family (e.g., ≈0.5 for uniform bits; HQC uses <code>2w(1 - w/n)/n</code>).</div>
        <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
          <strong>What is Hamming distance?</strong>
          The Hamming distance between two equal‑length bitstrings is the number of bit positions where they differ.
          Here we normalise it as a fraction in [0, 1] by dividing by the bit length. For each algorithm, we generate multiple
          secret keys and compute distances across sampled key pairs to summarise randomness properties. For truly uniform
          random keys, the expected fraction is ≈0.5 (half the bits differ on average). Some schemes (e.g., constant‑weight
          constructions like HQC’s secret vectors) have different expectations; in those cases the theoretical expected fraction is shown.
          Large deviations from expectation can indicate issues in key generation, encoding, or parameter handling.
        </div>
      </div>
    </div>
  </div>

  <!-- Secret-Key Hamming Weight section -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Secret-Key Hamming Weight (HW)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Mean fraction of 1-bits in secret keys (per algorithm).</div>
        <canvas id="hw-bar" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">HW Statistics (fraction)</div>
        <table class="vlines">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Samples</th>
              <th>Mean</th>
              <th>Stddev</th>
              <th>Min</th>
              <th>Max</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody>
            {% for a in compare.algos %}
            {% set ana = a.meta.secret_key_analysis if a.meta and a.meta.secret_key_analysis else None %}
            {% set hw = ana.hw if ana and ana.hw else None %}
            <tr>
              <td>{{ a.label }}</td>
              <td>{% if ana and compare and compare.runs is not none %}{{ ana.samples or '-' }}{% else %}{% if hw and hw.mean_fraction is not none %}{{ ana.samples or '-' }}{% else %}-{% endif %}{% endif %}</td>
              <td>{% if hw and hw.mean_fraction is not none %}{{ '%.4f'|format(hw.mean_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.std_fraction is not none %}{{ '%.4f'|format(hw.std_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.min_fraction is not none %}{{ '%.4f'|format(hw.min_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.max_fraction is not none %}{{ '%.4f'|format(hw.max_fraction) }}{% else %}-{% endif %}</td>
              <td>{% if hw and hw.expected_fraction is not none %}{{ '%.4f'|format(hw.expected_fraction) }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="hint" style="margin-top:.5rem; opacity:.85; font-size:.9rem;">Expected depends on scheme/family (uniform random bits ≈0.5; constant‑weight secrets use <code>w/n</code> where <code>w</code> is the weight and <code>n</code> the length).</div>
        <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
          <strong>What is Hamming weight?</strong>
          The Hamming weight of a bitstring is the number of 1‑bits it contains. Normalising by bit length gives a fraction in [0, 1].
          For uniformly random secrets, the expected fraction is ≈0.5. Some constructions are not uniform; for example, constant‑weight
          schemes fix exactly <em>w</em> ones among <em>n</em> bits so the expected fraction is <em>w/n</em>. Comparing observed vs expected
          helps flag RNG or encoding anomalies in key generation.
        </div>
      </div>
    </div>
  </div>

  <!-- Security Analysis section -->
  <div class="island">
    <div class="row-grid-2">
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Classical Security (bits)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Estimated classical attack cost per algorithm.</div>
        <canvas id="sec-classical" style="width:100%; height:260px;"></canvas>
      </div>
      <div class="card">
        <div style="font-weight:700; margin-bottom:.5rem;">Quantum Security (bits)</div>
        <div style="opacity:.9; font-size:.92rem; margin-bottom:.35rem;">Estimated quantum attack cost per algorithm.</div>
        <canvas id="sec-quantum" style="width:100%; height:260px;"></canvas>
      </div>
    </div>
    <div class="card" style="margin-top:1.25rem;">
      <div style="font-weight:700; margin-bottom:.5rem;">Security Summary</div>
      <div style="display:flex; align-items:center; gap:.75rem; margin:.35rem 0 .75rem 0;">
        <label style="display:flex; align-items:center; gap:.35rem; cursor:pointer;">
          <input type="checkbox" id="toggle-lattice-cols" />
          <span style="font-size:.92rem; opacity:.9;">Show modeled bits alongside headline</span>
        </label>
      </div>
      <table class="vlines">
        <thead>
          <tr>
            <th>Algorithm</th>
            <th>NIST category</th>
            <th>Category floor</th>
            <th>Classical bits</th>
            <th>Quantum bits</th>
            <th>Shor breakable</th>
            <th>Estimator</th>
            <th class="col-modeled" style="display:none;">Classical (modeled)</th>
            <th class="col-modeled" style="display:none;">Quantum (modeled)</th>
          </tr>
        </thead>
        <tbody>
          {% for a in compare.algos %}
          {% set s = a.security if a.security else {} %}
          {% set headline = s.headline if s and s.headline else {} %}
          <tr>
            <td>{{ a.label }}</td>
            <td>{% if s.nist_category is not none %}{{ s.nist_category }}{% else %}-{% endif %}</td>
            <td>{% if s.category_floor is not none %}{{ s.category_floor }}{% else %}-{% endif %}</td>
            <td>{% if headline.classical_bits is number %}{{ '%.2f'|format(headline.classical_bits) }}{% else %}-{% endif %}</td>
            <td>{% if headline.quantum_bits is number %}{{ '%.2f'|format(headline.quantum_bits) }}{% else %}-{% endif %}</td>
            <td>
              {% if s.shor_breakable is not none %}
                {% if s.shor_breakable %}<span style="color:#ffb3b3;">Yes</span>{% else %}<span style="color:#b3ffb3;">No</span>{% endif %}
              {% else %}-{% endif %}
            </td>
            <td>
              {% if headline.estimator %}{{ headline.estimator }}{% else %}-{% endif %}
              {% if headline.attack %} <span class="kv-sub">({{ headline.attack }})</span>{% endif %}
            </td>
            <td class="col-modeled" style="display:none;">
              {% if headline.classical_bits_range %}
                {{ '%.2f'|format(headline.classical_bits_range[0]) }} – {{ '%.2f'|format(headline.classical_bits_range[1]) }}
              {% else %}-{% endif %}
            </td>
            <td class="col-modeled" style="display:none;">
              {% if headline.quantum_bits_range %}
                {{ '%.2f'|format(headline.quantum_bits_range[0]) }} – {{ '%.2f'|format(headline.quantum_bits_range[1]) }}
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:.6rem; font-size:.95rem; line-height:1.4;">
        <strong>How to read this:</strong> “Bits” are estimated work factors: higher is better (harder to break). Classical bits approximate cost under classical attacks; quantum bits under realistic quantum models. “Shor breakable” highlights schemes vulnerable to Shor’s algorithm (e.g., RSA, ECC). Values depend on estimator settings (profile, physical error rates, etc.).
      </div>
    </div>
    <!-- Security Model Details (Lattice/ISD/Hash/MQ) -->
    <div class="card" style="margin-top:1.25rem;">
      <div style="font-weight:700; margin-bottom:.5rem;">Security Model Details</div>
      <table class="vlines">
        <thead>
          <tr>
            <th>Algorithm</th>
            <th>Model</th>
            <th>Best attack</th>
            <th>Key metrics &amp; parameters</th>
          </tr>
        </thead>
        <tbody>
          {% for a in compare.algos %}
          {% set s = a.security if a.security else {} %}
          {% set headline = s.headline if s and s.headline else {} %}
          {% set rows = s.detail_rows if s and s.detail_rows else [] %}
          <tr>
            <td>{{ a.label }}</td>
            <td>{% if headline.model %}{{ headline.model }}{% else %}-{% endif %}</td>
            <td>{% if headline.attack %}{{ headline.attack }}{% else %}-{% endif %}</td>
            <td>
              {% if rows %}
                <ul style="margin:0; padding-left:1.1rem;">
                  {% for row in rows %}
                    <li style="margin-bottom:0.25rem;"><strong>{{ row[0] }}:</strong> {{ row[1] }}</li>
                  {% endfor %}
                </ul>
              {% else %}-{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="kv-sub" style="margin-top:.4rem;">
        Models: Kyber/Dilithium → Module‑LWE BKZ (primal/dual/hybrid); Falcon → NTRU BKZ; HQC → ISD (Stern/BJMM);
        SPHINCS+/XMSS → hash bounds; MAYO → MQ checks (rank/minrank). Detailed curves and constants appear in raw JSON
        under "details.*" blocks (e.g., details.module_lwe_*, details.falcon_bkz_model).
      </div>
    </div>
    <div class="card" style="margin-top:1.25rem;">
      <div style="font-weight:700; margin-bottom:.5rem;">Security Notes</div>
      {% set ns = namespace(found=False) %}
      {% for a in compare.algos %}
        {% set s = a.security if a.security else {} %}
        {% set headline = s.headline if s and s.headline else {} %}
        {% set notes = headline.notes if headline and headline.notes else [] %}
        {% if notes %}
          {% set ns.found = True %}
          <div style="margin-bottom:.9rem;">
            <div style="font-weight:600;">{{ a.label }}</div>
            <ul style="margin:0.35rem 0 0 1.2rem; padding:0;">
              {% for note in notes %}
              <li style="margin-bottom:0.25rem;">{{ note }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      {% endfor %}
      {% if not ns.found %}
        <div class="kv-sub">No additional notes for these algorithms.</div>
      {% endif %}
    </div>
  </div>

  <script>
    (function(){
      const data = {{ compare|tojson }};
      const algos = Array.isArray(data.algos) ? data.algos : [];
      const labels = [];
      const classical = [];
      const quantum = [];
      for (const a of algos) {
        const s = a && a.security || {};
        const cb = (typeof s.classical_bits === 'number') ? s.classical_bits : null;
        const qb = (typeof s.quantum_bits === 'number') ? s.quantum_bits : null;
        labels.push(a.label || a.name || '?');
        classical.push(cb);
        quantum.push(qb);
      }
      function buildBar(elId, ds, color, title){
        const el = document.getElementById(elId);
        if (!el) return;
        const filtered = ds.map((v) => (typeof v === 'number' ? v : null));
        if (filtered.every(v => v == null)) {
          const msg = document.createElement('div');
          msg.textContent = 'No data available.';
          msg.style.opacity = '0.9';
          msg.style.fontSize = '.95rem';
          el.parentElement.appendChild(msg);
          return;
        }
        try {
          const ctx = el.getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{ label: title, data: filtered, backgroundColor: color }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Bits' }, ticks: { color:'#fff' } },
                x: { ticks: { color:'#fff' } }
              },
              plugins: { legend: { display: false } },
              animation: false,
              normalized: true,
            }
          });
        } catch (e) {}
      }
      buildBar('sec-classical', classical, '#4d9dff', 'Classical bits');
      buildBar('sec-quantum', quantum, '#c792ea', 'Quantum bits');
    })();
  </script>
  <script>
    // Toggle modeled columns in Security Summary
    (function(){
      const cb = document.getElementById('toggle-lattice-cols');
      if (!cb) return;
      function update(){
        const show = !!cb.checked;
        document.querySelectorAll('.col-modeled').forEach(el => { el.style.display = show ? '' : 'none'; });
      }
      cb.addEventListener('change', update);
      update();
    })();
  </script>

  <!-- Projected runtimes (runtime scaling) -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Projected Runtimes (by device)</div>
      <div id="runtime-charts" class="grid"></div>
    </div>
  </div>

  <script>
    (function(){
      const data = {{ compare|tojson }};
      const ops = data.kind === 'KEM' ? ['keygen','encapsulate','decapsulate'] : ['keygen','sign','verify'];
      const host = document.getElementById('runtime-charts');
      if (!host) return;
      // Collect available target devices across algos/ops
      const deviceSet = new Set();
      for (const a of (data.algos||[])) {
        for (const op of ops) {
          const s = a.ops && a.ops[op];
          const rs = s && s.runtime_scaling;
          if (rs && rs.predictions) {
            Object.keys(rs.predictions).forEach(k => deviceSet.add(k));
          }
        }
      }
      const devices = Array.from(deviceSet).sort();
      if (!devices.length) {
        const msg = document.createElement('div');
        msg.className = 'kv-sub';
        msg.textContent = 'Runtime scaling unavailable (no device predictions).';
        host.appendChild(msg);
        return;
      }
      const palette = ['#1fb6b8','#ffd166','#4d9dff'];
      function addDeviceChart(device){
        const wrap = document.createElement('div');
        wrap.className = 'card';
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.marginBottom = '.25rem';
        title.textContent = `Device: ${device}`;
        wrap.appendChild(title);
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '260px';
        wrap.appendChild(canvas);
        // Labels are algorithm display names
        const labels = (data.algos||[]).map(a => a.label || a.name || '?');
        const datasets = ops.map((op, idx) => {
          const series = [];
          for (const a of (data.algos||[])) {
            const rs = a.ops && a.ops[op] && a.ops[op].runtime_scaling;
            const pred = rs && rs.predictions && rs.predictions[device];
            series.push(pred && typeof pred.predicted_ms === 'number' ? pred.predicted_ms : null);
          }
          return {
            label: op.charAt(0).toUpperCase()+op.slice(1),
            data: series,
            backgroundColor: palette[idx % palette.length],
          };
        });
        try {
          const ctx = canvas.getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'ms' }, ticks:{ color:'#fff' } },
                x: { ticks:{ color:'#fff' } }
              },
              plugins: { legend: { position:'bottom', labels:{ color:'#fff', usePointStyle:true, boxWidth:10, boxHeight:10 } } },
              animation: false,
              normalized: true,
            }
          });
        } catch (e) {}
        host.appendChild(wrap);
      }
      devices.forEach(addDeviceChart);
    })();
  </script>

  <!-- Brute-Force Baseline (educational) -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Brute-Force Baseline (educational)</div>
      <div class="grid">
        {% for a in compare.algos %}
        {% set s = a.security if a.security else {} %}
        {% set bf = s.bruteforce if s and s.bruteforce else None %}
        <div class="card" style="min-width:260px;">
          <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
          {% if bf %}
            <table class="kv"><tbody>
              <tr><td class="kv-label">Model</td><td class="kv-value">{{ bf.model }}</td></tr>
              <tr><td class="kv-label">Search space</td><td class="kv-value">2^{{ '%.0f'|format(bf.space_bits) if bf.space_bits is number else bf.space_bits }}</td></tr>
              <tr><td class="kv-label">Rate unit</td><td class="kv-value">{{ bf.rate_unit }}</td></tr>
            </tbody></table>
            <div style="margin-top:.5rem; font-weight:600;">Time to succeed (years)</div>
            <table class="vlines" style="margin-top:.25rem;">
              <thead>
                <tr>
                  <th style="text-align:left;">Rate</th>
                  <th>Years</th>
                  <th>log10</th>
                </tr>
              </thead>
              <tbody>
                {% for rate in bf.rates %}
                {% set key = (rate|string) %}
                {% set row = bf.time_years[key] if bf.time_years and key in bf.time_years else None %}
                <tr>
                  <td style="text-align:left;">
                    {% if bf.rate_unit == 'cores' %}{{ rate|int }} cores{% else %}{{ '%.0e'|format(rate) }} t/s{% endif %}
                  </td>
                  <td>{% if row and row.sci %}{{ row.sci }}{% else %}-{% endif %}</td>
                  <td>{% if row and row.log10 is not none %}{{ '%.2f'|format(row.log10) }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% if bf.assumptions and bf.assumptions.rationale %}
              <div class="kv-sub" style="margin-top:.35rem;">{{ bf.assumptions.rationale }}</div>
            {% endif %}
          {% else %}
            <div class="kv-sub">No brute-force baseline available.</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="kv-sub" style="margin-top:.5rem; opacity:.85;">Note: This baseline is educational. Real parameters are astronomically out of reach; see docs/security/BRUTEFORCE.md.</div>
    </div>
  </div>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const el = document.getElementById('hd-bar');
      if (!el || !compareData || !Array.isArray(compareData.algos)) return;
      const rows = [];
      for (const a of compareData.algos) {
        const ana = a && a.meta && a.meta.secret_key_analysis;
        const hd = ana && ana.hd;
        if (hd && hd.mean_fraction != null) {
          rows.push({
            label: a.label || a.name || '?',
            mean: +hd.mean_fraction,
            exp: (hd.expected_fraction != null ? +hd.expected_fraction : null)
          });
        }
      }
      if (!rows.length) {
        // No data: show a subtle message
        const msg = document.createElement('div');
        msg.textContent = 'No HD data available for the selected algorithms.';
        msg.style.opacity = '0.9';
        msg.style.fontSize = '.95rem';
        el.parentElement.appendChild(msg);
        return;
      }
      const labels = rows.map(r => r.label);
      const means = rows.map(r => r.mean);
      const expects = rows.map(r => r.exp);
      const hasAnyExpected = expects.some(v => v != null);
      try {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'HD mean fraction',
                data: means,
                backgroundColor: '#1fb6b8',
              },
              ...(hasAnyExpected ? [{
                label: 'Expected fraction',
                data: expects,
                backgroundColor: '#ffd166',
                borderColor: '#ffd166',
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'Fraction' },
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 1,
                ticks: { color: '#fff', callback: (v) => (typeof v === 'number' ? v.toFixed(2) : v) }
              },
              x: { ticks: { color: '#fff' } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
              tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(4) : ctx.parsed.y) } }
            },
            animation: false,
            normalized: true,
          }
        });
      } catch (e) { /* ignore */ }
    })();
  </script>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const el = document.getElementById('hw-bar');
      if (!el || !compareData || !Array.isArray(compareData.algos)) return;
      const rows = [];
      for (const a of compareData.algos) {
        const ana = a && a.meta && a.meta.secret_key_analysis;
        const hw = ana && ana.hw;
        if (hw && hw.mean_fraction != null) {
          rows.push({
            label: a.label || a.name || '?',
            mean: +hw.mean_fraction,
            exp: (hw.expected_fraction != null ? +hw.expected_fraction : null)
          });
        }
      }
      if (!rows.length) {
        const msg = document.createElement('div');
        msg.textContent = 'No HW data available for the selected algorithms.';
        msg.style.opacity = '0.9';
        msg.style.fontSize = '.95rem';
        el.parentElement.appendChild(msg);
        return;
      }
      const labels = rows.map(r => r.label);
      const means = rows.map(r => r.mean);
      const expects = rows.map(r => r.exp);
      const hasAnyExpected = expects.some(v => v != null);
      try {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'HW mean fraction',
                data: means,
                backgroundColor: '#7ed957',
              },
              ...(hasAnyExpected ? [{
                label: 'Expected fraction',
                data: expects,
                backgroundColor: '#ffd166',
                borderColor: '#ffd166',
              }] : [])
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                title: { display: true, text: 'Fraction' },
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 1,
                ticks: { color: '#fff', callback: (v) => (typeof v === 'number' ? v.toFixed(2) : v) }
              },
              x: { ticks: { color: '#fff' } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { color: '#fff', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
              tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(4) : ctx.parsed.y) } }
            },
            animation: false,
            normalized: true,
          }
        });
      } catch (e) { /* ignore */ }
    })();
  </script>

  <!-- LLM Analysis section (appears before Raw Exports) -->
  <div class="island">
    <div class="card card--full" style="display:flex; flex-direction:column; gap:.6rem;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap;">
        <div style="font-weight:700;">AI-Assisted Analysis</div>
        <div style="opacity:.9; font-size:.9rem;">
          <span id="llm-provider-hint">Provider: auto (configurable)</span>
        </div>
      </div>
      <div style="display:flex; gap:.6rem; align-items:flex-start; flex-wrap:wrap;">
        <div style="flex:1 1 420px; min-width:260px;">
          <label for="llm-user-request" style="display:block; font-weight:600; margin-bottom:.25rem;">Custom request (optional)</label>
          <textarea id="llm-user-request" rows="2" placeholder="e.g., Focus on verify latency outliers and memory spikes; call out which algos fit microcontrollers vs. servers." style="width:100%; max-width:100%; resize:none; padding:.6rem .7rem; border-radius:.45rem; border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.2); color:#fff; box-sizing:border-box;"></textarea>
          <div class="kv-sub" style="margin-top:.25rem; opacity:.85;">Leave empty for a general summary.</div>
        </div>
      </div>
      <div id="llm-analysis-output" style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.5rem; min-height: 80px; line-height:1.35; margin-top:.5rem;">
        Click "Generate Analysis" to summarize these results.
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; align-items:center;">
        <button id="llm-generate" type="button">Generate Analysis</button>
        <button id="llm-regenerate" type="button" style="display:none;" class="btn">Regenerate</button>
      </div>
      <div id="llm-analysis-error" style="display:none; color:#ffdddd; background:#902; padding:.5rem .75rem; border-radius:.4rem;"></div>
    </div>
  </div>

  <!-- Markdown rendering libs (tiny, via CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script>
    (function(){
      const compareData = {{ compare|tojson }};
      const out = document.getElementById('llm-analysis-output');
      const btn = document.getElementById('llm-generate');
      const btnRe = document.getElementById('llm-regenerate');
      const err = document.getElementById('llm-analysis-error');
      const hint = document.getElementById('llm-provider-hint');
      const reqEl = document.getElementById('llm-user-request');

      async function runAnalysis() {
        err.style.display = 'none';
        err.textContent = '';
        btn.disabled = true; btnRe.disabled = true;
        const prevHTML = out.innerHTML;
        out.textContent = 'Generating analysis...';
        try {
          const res = await fetch('/api/analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ compare: compareData, request: (reqEl && reqEl.value && reqEl.value.trim()) ? reqEl.value.trim() : undefined })
          });
          const data = await res.json();
          if (!data || data.ok === false) {
            throw new Error((data && data.error) || 'Analysis failed');
          }
          const provider = (data.provider || 'auto');
          const model = (data.model || '');
          const usedFallback = !!data.used_fallback;
          if (hint) {
            hint.textContent = 'Provider: ' + provider + (model ? (' • ' + model) : '') + (usedFallback ? ' (fallback)' : '');
          }
          const text = (data.analysis || '').trim();
          if (text) {
            try {
              const html = (window.marked ? marked.parse(text) : text);
              out.innerHTML = (window.DOMPurify ? DOMPurify.sanitize(html) : html);
            } catch (e) {
              out.textContent = text; // fallback to plain text
            }
          } else {
            out.textContent = 'No analysis returned.';
          }
          // Surface provider error inline if we fell back
          if (usedFallback && data.error) {
            err.style.display = 'block';
            let msg = 'Provider error: ' + String(data.error);
            if (data.meta && data.meta.endpoint) {
              msg += ' • endpoint: ' + String(data.meta.endpoint);
            }
            err.textContent = msg;
          } else {
            err.style.display = 'none';
            err.textContent = '';
          }
          btnRe.style.display = 'inline-block';
        } catch (e) {
          out.innerHTML = prevHTML;
          err.style.display = 'block';
          err.textContent = String(e);
        } finally {
          btn.disabled = false; btnRe.disabled = false;
        }
      }

      btn.addEventListener('click', runAnalysis);
      btnRe.addEventListener('click', runAnalysis);
      // Auto-run once when the section loads
      try { runAnalysis(); } catch (e) {}
    })();
  </script>

  <!-- Raw exports section -->
  <div class="island">
    <div class="card card--full">
      <div style="font-weight:700; margin-bottom:.5rem;">Raw Exports</div>
      <details style="margin-top:.25rem;">
        <summary style="cursor:pointer;">View raw JSON</summary>
        <div style="margin-top:.6rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem;">
          {% for a in compare.algos %}
          <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.5rem; text-align:left;">
            <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
            {% set ex = a.exports if a.exports else (a.meta.exports if a.meta and a.meta.exports else None) %}
            {% if ex and ex.json %}
              <div><a href="/{{ ex.json }}" target="_blank" style="color:#aee; text-decoration:underline;">Open JSON summary</a></div>
            {% else %}
              <div style="opacity:.8;">No JSON export available.</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </details>

      <details style="margin-top:1rem;">
        <summary style="cursor:pointer;">View raw data (one run)</summary>
        <div style="margin-top:.6rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:1rem;">
          {% for a in compare.algos %}
          <div style="background:rgba(0,0,0,.25); padding:1rem; border-radius:.5rem; text-align:left;">
            <div style="font-weight:700; margin-bottom:.35rem;">{{ a.label }}</div>
            {% set ex = a.exports if a.exports else (a.meta.exports if a.meta and a.meta.exports else None) %}
            {% if ex and ex.trace %}
              <div><a href="/{{ ex.trace }}" target="_blank" style="color:#aee; text-decoration:underline;">Open raw trace</a></div>
            {% else %}
              <div style="opacity:.8;">No trace export available.</div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </details>
    </div>
  </div>
</body>
</html>
