{% import '_form_macros.html' as form %}
{% set operation = (selected_operation or 'compare') %}
{% set compare_kind = (compare_kind or 'KEM') %}
{% set compare_mode = (compare_mode or 'pair') %}
<style>
  /* Crossfade between KEM and SIG checkbox grids */
  #cmp_algo_list { border-top: 1px solid rgba(255,255,255,.22); border-bottom: 1px solid rgba(255,255,255,.18); }
  .algo-lists { position: relative; transition: height 200ms ease; }
  .fade-layer { position: absolute; inset: 0; opacity: 0; transition: opacity 180ms ease; pointer-events: none; }
  .fade-layer.is-active { opacity: 1; pointer-events: auto; }
  /* Keep checkbox card sizes constant by fixing item width */
  .algo-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 220px)); gap:.6rem; justify-content: start; align-content: start; }
</style>
<form method="POST" action="/execute" id="main-form">
  <input type="hidden" name="operation" value="compare" />
  <div class="form-grid" style="max-width: 680px; margin: 0 auto;">
    

    <div id="compare-fields" style="display: contents;">
      <!-- Top row: Algorithm Type, Runs, Message Size (SIG) -->
      <div class="field" style="grid-column: span 4;">
        <label for="cmp_kind">Algorithm Type</label>
        <select id="cmp_kind" name="kind">
          <option value="KEM" {% if compare_kind != 'SIG' %}selected{% endif %}>KEM</option>
          <option value="SIG" {% if compare_kind == 'SIG' %}selected{% endif %}>SIG</option>
        </select>
      </div>
      {{ form.number_field('cmp_runs', 'runs', 'Runs', default_runs or 10, column='span 2') }}
      <div class="field" style="grid-column: span 6;" id="cmp_msg_field">
        <label for="cmp_msg_select">Message size (SIG)</label>
        <select id="cmp_msg_select" name="message_size">
          {% set msg_default = (default_message_size or 1024) | int %}
          {% for size in [64,128,256,512,1024,2048,4096] %}
            <option value="{{ size }}" {% if msg_default == size %}selected{% endif %}>{{ size }} bytes</option>
          {% endfor %}
        </select>
      </div>

      <!-- Algorithms list (checkboxes) -->
      <div class="field field--full" id="cmp_algo_list" style="padding-top:.5rem; padding-bottom:.6rem; margin-top:.2rem; margin-bottom:.25rem;">
        <label>Algorithms</label>
        <div id="cmp_algo_list_body" class="algo-lists">
        <div id="cmp_algos_kem" class="fade-layer is-active algo-grid">
          {% for name in algos %}
            {% if kinds[name] == 'KEM' %}
            <label style="display:flex; gap:.5rem; align-items:center; background: rgba(0,0,0,.20); padding:.6rem .7rem; border-radius:.5rem;">
              <input type="checkbox" name="algos" value="{{name}}" />
              <span>{{ display_names.get(name, name) }}</span>
            </label>
            {% endif %}
          {% endfor %}
        </div>
        <div id="cmp_algos_sig" class="fade-layer algo-grid">
          {% for name in algos %}
            {% if kinds[name] == 'SIG' %}
            <label style="display:flex; gap:.5rem; align-items:center; background: rgba(0,0,0,.20); padding:.5rem .6rem; border-radius:.5rem;">
              <input type="checkbox" name="algos" value="{{name}}" />
              <span>{{ display_names.get(name, name) }}</span>
            </label>
            {% endif %}
          {% endfor %}
        </div>
        </div>
      </div>

      <!-- Cold starts -->
      <div class="field" style="grid-column: span 10;">
        <div class="checkbox-row">
          <input id="cmp_cold" type="checkbox" name="cold" checked />
          <label for="cmp_cold" style="margin:0;">Cold starts (fresh process per run)</label>
        </div>
      </div>

      <!-- Security estimator (unchanged, placed below) -->
      <div class="field field--full" style="margin-top:.4rem;">
        <div style="font-weight:600;">Security estimator</div>
        <div class="hint">Optional: configure the estimator inputs used for security summaries.</div>
      </div>
      <div class="field" style="grid-column: span 6;">
        <div class="checkbox-row">
          <input id="sec_adv_cmp" type="checkbox" name="sec_adv" {% if security_form.sec_adv %}checked{% endif %}/>
          <label for="sec_adv_cmp" style="margin:0;">Advanced lattice estimator</label>
        </div>
      </div>
      <div class="field" style="grid-column: span 6;">
        <div class="checkbox-row">
          <input id="sec_rsa_phys_cmp" type="checkbox" name="sec_rsa_phys" {% if security_form.sec_rsa_phys %}checked{% endif %}/>
          <label for="sec_rsa_phys_cmp" style="margin:0;">Include RSA surface-code overhead</label>
        </div>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_profile_cmp">Security profile</label>
        <select id="sec_profile_cmp" name="sec_profile">
          {% for profile in security_profile_choices %}
            <option value="{{ profile }}" {% if security_form.sec_profile == profile %}selected{% endif %}>{{ profile|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_phys_error_rate_cmp">Physical error rate</label>
        <input id="sec_phys_error_rate_cmp" name="sec_phys_error_rate" type="number" step="any" min="0" value="{{ security_form.sec_phys_error_rate }}" />
        <div class="hint">Probability per physical operation.</div>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_cycle_time_ns_cmp">Cycle time (ns)</label>
        <input id="sec_cycle_time_ns_cmp" name="sec_cycle_time_ns" type="number" step="any" min="0" value="{{ security_form.sec_cycle_time_ns }}" />
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="sec_fail_prob_cmp">Target fail probability</label>
        <input id="sec_fail_prob_cmp" name="sec_fail_prob" type="number" step="any" min="0" value="{{ security_form.sec_fail_prob }}" />
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="quantum_arch_cmp">Quantum arch preset</label>
        <select id="quantum_arch_cmp" name="quantum_arch">
          {% for value, label in quantum_arch_choices %}
            <option value="{{ value }}" {% if security_form.quantum_arch == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field" style="grid-column: span 4;">
        <label for="rsa_model_cmp">RSA resource model</label>
        <select id="rsa_model_cmp" name="rsa_model">
          {% for model in rsa_model_choices %}
            <option value="{{ model }}" {% if security_form.rsa_model == model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
        <div class="hint">Applies to RSA baselines only.</div>
      </div>
    </div>
  </div>
  <div class="actions">
    <button class="muted-btn" type="reset">Reset</button>
    <button type="submit">Run</button>
  </div>
</form>

<script>
  (function(){
    const kinds = {{ kinds|tojson }};
    const compareFields = document.getElementById('compare-fields');
    const cmpKind = document.getElementById('cmp_kind');
    const cmpMsgField = document.getElementById('cmp_msg_field');
    const cmpMsgSelect = document.getElementById('cmp_msg_select');
    const cmpAlgosKem = document.getElementById('cmp_algos_kem');
    const cmpAlgosSig = document.getElementById('cmp_algos_sig');
    const cmpAlgoListBody = document.getElementById('cmp_algo_list_body');

    const mainForm = document.getElementById('main-form');
    const loadingOverlay = document.getElementById('loading-overlay');

    function showLoadingOverlay(){
      if (!loadingOverlay) return;
      loadingOverlay.removeAttribute('hidden');
      loadingOverlay.classList.add('is-visible');
    }

    function hideLoadingOverlay(){
      if (!loadingOverlay) return;
      loadingOverlay.classList.remove('is-visible');
      loadingOverlay.setAttribute('hidden', 'hidden');
    }

    function refreshSingleSection(){
      // single-run UI removed
    }

    function setAlgoListHeight(target){
      if (!cmpAlgoListBody || !target) return;
      const h = target.scrollHeight;
      cmpAlgoListBody.style.height = h + 'px';
    }

    function refreshCompareSection(){
      if (!cmpKind) return;
      const isCompare = true; // Always compare mode on main page
      const isSig = (cmpKind.value === 'SIG');
      if (cmpMsgSelect) cmpMsgSelect.disabled = !isSig;
      if (cmpMsgField) cmpMsgField.style.opacity = isSig ? '1' : '.65';
      if (cmpAlgosKem && cmpAlgosSig) {
        if (isSig) {
          cmpAlgosSig.classList.add('is-active');
          cmpAlgosKem.classList.remove('is-active');
          setAlgoListHeight(cmpAlgosSig);
        } else {
          cmpAlgosKem.classList.add('is-active');
          cmpAlgosSig.classList.remove('is-active');
          setAlgoListHeight(cmpAlgosKem);
        }
      }
    }

    hideLoadingOverlay();

    window.addEventListener('pageshow', function(event){
      if (event && event.persisted) {
        hideLoadingOverlay();
      }
    });

    function refreshMode(){
      const isCompare = opSelect && opSelect.value === 'compare';
      toggleSection(singleFields, !isCompare);
      toggleSection(compareFields, isCompare);
      refreshSingleSection();
      refreshCompareSection();
    }

    // single-run UI removed
    if (cmpKind) cmpKind.addEventListener('change', refreshCompareSection);
    if (mainForm) {
      mainForm.addEventListener('submit', function(){
        if (typeof mainForm.checkValidity === 'function' && !mainForm.checkValidity()) {
          return;
        }
        window.requestAnimationFrame(showLoadingOverlay);
      });
    }

    // Initialize height to active list
    setTimeout(function(){
      if (cmpAlgosKem && cmpAlgosKem.classList.contains('is-active')) setAlgoListHeight(cmpAlgosKem);
      else if (cmpAlgosSig && cmpAlgosSig.classList.contains('is-active')) setAlgoListHeight(cmpAlgosSig);
    }, 0);
    refreshCompareSection();

    window.addEventListener('resize', function(){
      if (cmpAlgosKem && cmpAlgosKem.classList.contains('is-active')) setAlgoListHeight(cmpAlgosKem);
      else if (cmpAlgosSig && cmpAlgosSig.classList.contains('is-active')) setAlgoListHeight(cmpAlgosSig);
    });
  })();
</script>
